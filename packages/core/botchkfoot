
umask 077

lockfile="${pidfile}.lock"

has_command()
{

    command -v "$1" >/dev/null 2>&1

}

with_lock()
{

    # Prefer flock if available; fallback to mkdir lock
    if has_command flock
    then

        exec {lockfd}>"$lockfile"
        if ! flock -n "$lockfd"
        then

            # Another instance is running this script
            exit 0

        fi

        # lock stays held by FD

    else

        if mkdir "$lockfile" 2>/dev/null
        then

            trap 'rmdir "$lockfile" 2>/dev/null || true' EXIT

        else

            exit 0

        fi

    fi

}

is_pid_running()
{

    local pid="$1"

    if [[ ! "$pid" =~ ^[0-9]+$ ]]
    then

        return 1

    fi

    if kill -0 "$pid" 2>/dev/null
    then

        return 0

    fi

    return 1

}

remove_cantstart_if_userfile()
{

    if [[ -r "CANTSTART.$botname" ]]
    then

        if [[ -r "$userfile" || -r "$userfile~new" || -r "$userfile~bak" ]]
        then

            printf "\nUserfile found, removing check file 'CANTSTART.%s'...\n" "$botname"
            rm -f "CANTSTART.$botname"

        fi

    fi

}

start_bot()
{

    printf "\nCouldn't find bot '%s' running, reloading...\n\n" "$botname"

    if [[ -r "$userfile" ]]
    then

        ./"$botscript"

    elif [[ -r "$userfile~new" ]]
    then

        printf "Userfile missing. Using last saved userfile...\n"
        mv -f -- "$userfile~new" "$userfile"
        ./"$botscript"

    elif [[ -r "$userfile~bak" ]]
    then

        printf "Userfile missing. Using backup userfile...\n"
        cp -f -- "$userfile~bak" "$userfile"
        ./"$botscript"

    else

        printf "No userfile. Could not reload the bot...\n"
        printf "no userfile\n" > "CANTSTART.$botname"
        exit 1

    fi
}

main()
{
    cd "$botdir" || exit

    with_lock

    # Check if bot is already running
    if [[ -r "$pidfile" ]]
    then

        botpid=""
        if ! read -r botpid < "$pidfile"
        then

            botpid=""

        fi

        if is_pid_running "$botpid"
        then

            exit 0  # Bot is running

        fi

        printf "\nStale %s file, erasing...\n" "$pidfile"
        rm -f "$pidfile"

    fi

    remove_cantstart_if_userfile

    # Start bot if CANTSTART doesn't exist
    if [[ ! -f "CANTSTART.$botname" ]]
    then

        start_bot

    fi

}

main
