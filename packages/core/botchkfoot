
cd "$botdir"

# is there a pid file?
if [[ -r $pidfile ]]
then

    # there is a pid file -- is it current?
    botpid=$(cat "$pidfile")
    if kill -CHLD "$botpid" >/dev/null 2>&1
    then

        # it's still going -- back out quietly
        exit 0

    fi

    echo ""
    echo "Stale $pidfile file, erasing..."
    rm -f "$pidfile"

fi

if [[ -r CANTSTART.$botname ]]
then

    if [[ -r $userfile || -r $userfile~new || -r $userfile~bak ]]
    then

        echo ""
        echo "Userfile found, removing check file 'CANTSTART.$botname'..."
        rm -f CANTSTART.$botname

    fi

fi

# test if we have run botchk previously and didn't find a userfile
if [[ ! -f CANTSTART.$botname ]]
then

    echo ""
    echo "Couldn't find bot '$botname' running, reloading..."
    echo ""

    # check for userfile and reload bot if found
    if [[ -r $userfile ]]
    then

        # It's there, load the bot
        ./"$botscript"
        exit 0

    elif [[ -r $userfile~new ]]
    then

        # Bot f*@!ed up while saving the userfile last time.  Move it over.
        echo "Userfile missing.  Using last saved userfile..."
        mv -f "$userfile~new" "$userfile"
        ./"$botscript"
        exit 0

    elif [[ -r $userfile~bak ]]
    then

        # Userfile is missing, use backup userfile.
        echo "Userfile missing.  Using backup userfile..."
        cp -f "$userfile~bak" "$userfile"
        ./"$botscript"
        exit 0

    else

        # Well, nothing to work with...
        echo "No userfile.  Could not reload the bot..."
        echo "no userfile" > CANTSTART.$botname
        exit 1

    fi

fi

exit 0
